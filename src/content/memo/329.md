---
tags: ['']
status: release
ctime: 2024-12-31
mtime: 2024-12-31
---

이 코드는 Google Apps Script를 사용하여 Google Calendar와 상호작용하며, 주로 다음 두 가지 주요 기능을 제공합니다:

---

### **1. `fetchAvailability`: 시간 슬롯 조회**

- **기능**:

  - 지정된 조건(근무 요일, 시간, 및 이벤트 충돌 여부)에 따라 예약 가능한 시간 슬롯을 가져옵니다.
  - 결과는 사용자에게 제공할 수 있는 예약 가능한 시간 슬롯 목록과 해당 시간 슬롯의 지속 시간(분 단위)입니다.

- **주요 흐름**:
  1. 현재 시간을 기준으로 가장 가까운 시간 슬롯을 계산합니다. (슬롯 길이는 `TIMESLOT_DURATION`에 따라 설정됨)
  2. 28일(`DAYS_IN_ADVANCE`) 동안의 일정 기간을 설정합니다.
  3. `Calendar.Freebusy.query`를 사용하여 지정된 캘린더(`CALENDAR`)의 바쁜 일정(busy events)을 조회합니다.
  4. 조회된 이벤트를 기준으로 조건에 맞지 않는 시간 슬롯을 제외합니다:
     - 지정된 근무 시간(`WORKHOURS.start`, `WORKHOURS.end`) 외의 시간.
     - 근무일(`WORKDAYS`)이 아닌 요일.
     - 다른 이벤트와 시간이 겹치는 경우.
  5. 예약 가능한 시간 슬롯을 ISO 8601 형식의 문자열로 저장하고 반환합니다.

---

### **2. `bookTimeslot`: 시간 슬롯 예약**

- **기능**:

  - 사용자가 선택한 시간 슬롯에 이벤트를 생성하여 예약합니다.
  - 예약이 성공하면 Google Calendar에 이벤트를 추가하고 사용자에게 확인 메시지를 반환합니다.

- **주요 흐름**:
  1. 사용자가 선택한 시간 슬롯(`timeslot`)과 추가 정보(이름, 이메일, 전화번호, 메모)를 인수로 받습니다.
  2. 시간 슬롯의 유효성을 검증하고, `TIMESLOT_DURATION`을 기준으로 종료 시간을 계산합니다.
  3. `Calendar.Freebusy.query`를 통해 선택한 시간 동안 다른 이벤트가 있는지 확인합니다.
     - 이벤트가 겹치면 예약이 불가능하다는 에러를 반환합니다.
  4. 겹치는 이벤트가 없다면, `CalendarApp.getCalendarById`를 사용하여 Google Calendar에 새로운 이벤트를 생성합니다:
     - 이벤트 제목: 사용자 이름이 포함된 약속 제목.
     - 이벤트 설명: 전화번호와 메모를 포함.
     - 초대된 손님: 제공된 이메일로 초대.
     - 초대 메일 발송(`sendInvites: true`).
  5. 예약 성공 여부를 메시지로 반환합니다.

---

### **코드의 기타 주요 설정**

- **캘린더 및 시간대**:

  - 기본 캘린더 ID는 `"primary"`로 설정되어 있으며, 기본 시간대는 `"America/New_York"`입니다. 코드에는 다른 시간대에 대한 주석도 포함되어 있습니다.

- **근무 조건**:

  - `WORKDAYS`: 월요일부터 금요일(1~5).
  - `WORKHOURS`: 9시부터 13시까지.

- **시간 슬롯 길이**:
  - 30분(`TIMESLOT_DURATION` = 30).
  - 밀리초 변환(`TSDURMS`)을 통해 계산에 사용됩니다.

---

### **사용 시나리오**

1. **사용자가 예약 가능한 시간 조회**:

   - 프런트엔드에서 `fetchAvailability` 함수를 호출하면 예약 가능한 시간 슬롯 목록이 반환됩니다.

2. **사용자가 특정 시간에 예약**:
   - 선택된 시간과 정보를 `bookTimeslot`에 전달하여 캘린더 이벤트를 생성합니다.
   - 충돌이 없는 경우 성공적으로 예약되며, 이벤트 초대 이메일이 전송됩니다.

---

### **핵심 사용 사례**

- **캘린더 기반 예약 시스템**: 사용자의 예약 요청을 Google Calendar에 동기화하여 관리합니다.
- **자동화**: 특정 근무 시간과 일정을 고려하여 예약 가능성을 실시간으로 확인합니다.
- **이메일 알림**: 사용자가 이벤트에 초대되며, 알림 기능을 활용할 수 있습니다.
